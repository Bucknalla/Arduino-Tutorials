<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Arduino Tutorials by Bucknalla</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <style>
        li.L0, li.L1, li.L2, li.L3,
        li.L5, li.L6, li.L7, li.L8
        { list-style-type: decimal !important }
    </style>
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Digital Accelerometer &amp; SD Card Reader</h1>
      <h2 class="project-tagline">Warwick University - School of Engineering - Arduino Tutorials</h2>
      <a href="../3.html" class="btn"><</a>
      <a href="https://github.com/Bucknalla/Arduino-Tutorials" class="btn">View on GitHub</a>
      <a href="https://github.com/Bucknalla/Arduino-Tutorials/zipball/master" class="btn">Download .zip</a>
      <a href="http://pdfcrowd.com/?http://bucknalla.github.io/Arduino-Tutorials/3" class="btn">Save .pdf</a>
      <a href="../4.html" class="btn" style="visibility:hidden;">></a>
    </section>

    <section class="main-content">
      <h3><a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h3>

<p>The ability to collect data is an incredibly valuable tool to an Engineer, whether it's measuring the vibrations of traffic across a bridge to check for oscillations or to calculate the acceleration of rocket, it's essential to be able to effectively test and monitor a system.</p>

<p>Engineers in the field often need to verify that a systems is functioning correctly. This can often be a difficult task as conditions can be remote, harsh and sometimes even hostile! Fortunately tools such as a micro controller, can be employed to perform this monitoring for a far.</p>

<p>This tutorial will teach you how to interface with and collect data from a range of devices using a protocol known as SPI (Serial Peripheral Interface). This is an interface that will allow you to talk to sensors, storage and other devices. It is a general purpose protocol and can be used for a whole range of devices, beyond the Accelerometer and SD card examples used in this tutorial.</p>

<h3><a id="aims" class="anchor" href="#aims" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Aims</h3>

<p>By completing this tutorial, you should be able to confidently -</p>

<ul>
    <li>Communicate to the Arduino using a Serial Monitor</li>
    <li>Connect a sensor to an Arduino using the SPI bus and view the data over Serial</li>
    <li>Store this data using an SD card, allowing you to view the data at a later date</li>
</ul>

<br>

<img src="https://raw.githubusercontent.com/Bucknalla/Arduino-Tutorials/master/img/accelerometer-arduino.png" alt="accel-arduino">

<p style='text-align:center;'>An example of an Arduino setup to read a 3-axis accelerometer</p>


<h3><a id="getstarted" class="anchor" href="#getstarted" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get Started</h3>

<p>To begin this tutorial, ensure that the Arduino is connected to the Computer and open the Arduino IDE. Create a new file named 'dataLogging.ino' and delete any pre-existing code from the template that it opens. Create a folder within your documents called 'Tutorial_4'. Save the 'dataLogging.ino' file to this folder.</p>

<h3><a id="serialmonitor" class="anchor" href="#serialmonitor" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using the Serial Monitor to View Data</h3>

<p>First we'll begin by setting up a Serial connection to the Arduino so that the data being output by the accelerometer can be easily viewed.</p>

<p>Start by creating the setup and loop functions to create the Serial Interface. </p>

<pre class="prettyprint linenums">void setup(){
	Serial.begin(9600);	//Initialise Communication with PC
}

void loop(){
	Serial.print("Hello World!");	//Send characters to PC
	delay(1000);			//Delay for 1 second
}</pre>

<p>Click 'verify' to check your code for errors and then 'upload' to push the code to the Arduino. In the menu bar, you will find a dropdown called 'tools'. Click on this and you should see a button for the 'Serial Monitor'.</p>

<p>In the bottom right corner of the Serial Monitor, you will see a dropdown list, change this to the value '9600'. You should see the words 'Hello World!' printing to the Serial Monitor every 1 second.</p>

<p>This Serial Monitor code will be used later to read data from the accelerometer.</p>

<div class="infobox"><strong>Additional Information</strong><p>You will notice that a value of 9600 has been chosen for the Serial.begin() instruction.
This is not arbitrary and is known as the Serial Baud Rate.
There is a set of standard values, with 9600 often being used as default on many devices.
The value does not really matter, and you may use a different one, as long as you select
the corresponding value in the Serial Monitor.
The Serial communication involves a Tx and Rx line which is connected internally to pins D0 and D1,
for this reason, it is <strong>important not to connect any wires to these 2 pins</strong> as it can interfere with the communications. Visit this webpage to find out more about the <a href="https://www.arduino.cc/en/Reference/Serial">Serial Interface</a>. (https://www.arduino.cc/en/Reference/Serial)</p></div>


<h3><a id="accelerometer" class="anchor" href="#accelerometer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setting up the Accelerometer</h3>

<p>To read data from the accelerometer, start by wiring up the ADXL345 board to the Arduino.</p>

<p>Now you should begin to write the code required to communicate between the Arduino and your computer. First you'll start by adding a line of code to the top of the program to tell the Arduino that you wish to use the SPI library.</p>

<h4>Initialising the SPI library</h4>

<p>Add the following line above the code you previously have written.</p>

<pre class="prettyprint linenums">#include &lt;SPI.h&gt;</pre>

<p>This line of code tells the compiler which libraries to include when compiling the code for the Arduino.</p>

<p>Next you will want to define the pin values, which tells the Arduino which pins you have used to connect the accelerometer to. Append the following code to the setup function so that it looks the same as below.</p>

<pre class="prettyprint linenums">
void setup(){
    Serial.begin(9600);     //Include the Serial initialisation from earlier
    uint8_t AccelCS = 10;
    pinMode(AccelCS, OUTPUT);   //Accel. Chip Select pin is an output form the Arduino
}
</pre>

<p>You do not need to define the additional pins as they are already defined in the SPI library. Check the wiring diagram to familiarise yourself with which pins the library uses.</p>

<p>Once these pins have been defined, the SPI can be initialised in much the same way as Serial was. Add the following line to the setup function.</p>

<pre class="prettyprint">
SPI.begin();
</pre>

<p>The <a href="https://github.com/Bucknalla/Arduino-Tutorials/raw/master/Tutorial_4/ADXL345.pdf">datasheet</a> shows that the communication protocol is MODE3, hence we start with that:</p>
<pre class="prettyprint">
SPI.setDataMode(SPI_MODE3);
</pre>

<p>This ensures that the Arduino communicates in a way that the Accelerometer understands.</p>

<p>Next we need to specific which address the accelerometer will use. Add the following 2 snippets to the setup function. The accelerometer datasheet indicates that the following can be set:</p>

<pre class="prettyprint">
char POWER_CTL = 0x2D;  //Power Control Register
char DATA_FORMAT = 0x31;
</pre>

<p>The axis data is stored in addresses as follows (note that each axis value is split over 2 bytes (addresses)):</p>

<pre class="prettyprint">
char DATAX0 = 0x32; //X-Axis Data 0
char DATAX1 = 0x33; //X-Axis Data 1
char DATAY0 = 0x34; //Y-Axis Data 0
char DATAY1 = 0x35; //Y-Axis Data 1
char DATAZ0 = 0x36; //Z-Axis Data 0
char DATAZ1 = 0x37; //Z-Axis Data 1
</pre>

<p>These are all assigned as variables at the beginning of the code to aid readability and ease modification in the future.</p>

<p>We also initialise variables for each of the axis and a buffer to store incoming data:</p>

<pre class="prettyprint">
char values[10]; //This buffer will hold values read from the ADXL345 registers.
int x, y, z; //These variables will be used to hold the x,y and z axis accelerometer values.
</pre>

<p>The initalisation is now complete, however we must write functions to read from and write to the Accelerometer.</p>

<h4>Writing to the Accelerometer</h4>

<p>There will be many times throughout the program that data needs to be written to the Accelerometer, therefore the code is written as a function.</p>

<p>To write the function we first declare the name and inputs:<p>

<pre class="prettyprint linenums:7">
void writeAccel(char registerAddress, char value) {
    //Set Chip Select pin low to signal the beginning of an SPI packet.
    digitalWrite(AccelCS, LOW);
    //Transfer the register address over SPI.
    SPI.transfer(registerAddress);
    //Transfer the desired register value over SPI.
    SPI.transfer(value);
    //Set the Chip Select pin high to signal the end of an SPI packet.
    digitalWrite(AccelCS, HIGH);
}
</pre>

<p>From the code snippet above, you can see that the chip select pin is pulled low to start communication with the device.</p>

<p>Two useful parts of information are sent, the first one being the address of where we want to send the value (inside the Accelerometer) and the second being the actual value that we want to save. (RegisterAddress and value respectively).</p>

<h4>Reading from the Accelerometer</h4>

<p>Next we'll begin reading from the accelerometer. Similarily to the write function, you'll want to create another function for read.</p>

<p>Reading from the accelerometer is slightly more complex due to the fact that the incoming data length may vary. Firstly we prepare the register address by setting the most significant bit to a 1 (for those interested search for bitwise logic). Also, furthermore, if we need to read more than 1 byte, then bit6 is required to be set also.
</p>

<pre class="prettyprint linenums:18">
void readRegister(char registerAddress, int numBytes, char * values) {
  //Since we're performing a read operation, the most significant bit of the register address should be set.
  char address = 0x80 | registerAddress;
  //If we're doing a multi-byte read, bit 6 needs to be set as well.
  if (numBytes > 1)address = address | 0x40;
  //Set the Chip select pin low to start an SPI packet.
  digitalWrite(AccelCS, LOW);
  //Transfer the starting register address that needs to be read.
  SPI.transfer(address);
  //Continue to read registers until we've read the number specified, storing the results to the input buffer.
  for (int i = 0; i < numBytes; i++) {
    values[i] = SPI.transfer(0x00);
  }
  //Set the Chips Select pin high to end the SPI packet.
  digitalWrite(AccelCS, HIGH);
}
</pre>

<p>As with the write function, the AccelCS pin is pulled low to initialise communication and the address is transferred.
Then a zero is transferred as many times as there are number of bytes that we want to read. Each time the result is saved into 'values array'. Finally, the CS pin is pulled high and the read process finished.</p>

<h4>Looping the Code</h4>

<p>Finally we will write code to get the data and display it over the serial port. This will be performed by the loop function so we can .</p>


<h3><a id="sdcard" class="anchor" href="#sdcard" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Connecting the SD Card Reader to log Data</h3>

      <footer class="site-footer">
        <span class="site-footer-owner">Content belongs to <a href="http://www2.warwick.ac.uk/">Warwick University</a> - <a href="http://www2.warwick.ac.uk/fac/sci/eng/">School of Engineering</a> and is maintained by <a href="https://github.com/Bucknalla">Alex Bucknall</a> and <a href="https://github.com/slinkyfish">Stephen Pithouse</a>.</span>

        <!--<span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>-->
      </footer>

    </section>


  </body>
</html>
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=c&amp;skin=default"></script>
